{% extends "base.html" %}

{% block title %}Результаты классификации{% endblock %}

{% block content %}

<section class="card">
    <h2>Итоговая статистика</h2>
    <div class="stats">
        {% for label in labels_order %}
            <div class="stat-item">
                <div class="stat-label">{{ label }}</div>
                <div class="stat-value">{{ counts.get(label, 0) }}</div>
            </div>
        {% endfor %}
    </div>

    <div class="chart-wrapper">
        <canvas id="sentimentChart"></canvas>
    </div>

    <a class="button primary" href="{{ url_for('download', file_id=file_id) }}">
        Скачать размеченный CSV
    </a>
    <a class="button primary" href="{{ url_for('submission', file_id=file_id) }}">
    Скачать submission.csv
    </a>

    <a class="button" href="{{ url_for('index') }}">На главную</a>
</section>

<section class="card">
    <h2>Предсказанные отзывы (первые 200)</h2>

    <div class="filters">
        <input type="text" id="searchInput" placeholder="Поиск по тексту...">
        <select id="sentimentFilter">
            <option value="">Все тональности</option>
            {% for label in labels_order %}
                <option value="{{ label }}">{{ label }}</option>
            {% endfor %}
        </select>
    </div>

    <table id="resultsTable">
        <thead>
            <tr>
                <th>#</th>
                <th>Текст</th>
                <th>Источник (src)</th>
                <th>Тональность</th>
            </tr>
        </thead>
        <tbody>
            {% for row in table %}
                <tr data-sentiment="{{ row['label_name'] | e }}">
                    <td>{{ loop.index }}</td>
                    <td class="text-cell">{{ row['text'] }}</td>
                    <td>{{ row['src'] }}</td>
                    <td>{{ row['label_name'] }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</section>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // --- данные для графика ---
    const labelsData = {{ labels_order | tojson }};
    const countsData = {{ counts | tojson }};

    const chartLabels = labelsData;
    const chartData = chartLabels.map(label => countsData[label] || 0);

    const canvas = document.getElementById('sentimentChart');
    if (canvas) {
        const ctx = canvas.getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Количество отзывов',
                    data: chartData
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { precision: 0 }
                    }
                }
            }
        });
    }

    // --- фильтрация/поиск ---
    const searchInput = document.getElementById('searchInput');
    const sentimentFilter = document.getElementById('sentimentFilter');
    const tableBody = document.querySelector('#resultsTable tbody');
    if (!searchInput || !sentimentFilter || !tableBody) {
        console.warn("Фильтры не инициализированы: нет нужных элементов на странице.");
        return;
    }

    const tableRows = Array.from(tableBody.querySelectorAll('tr'));

    function applyFilters() {
        const query = searchInput.value.toLowerCase().trim();
        const sentiment = sentimentFilter.value;

        tableRows.forEach(row => {
            const textCell = row.querySelector('.text-cell');
            const rowSentiment = row.getAttribute('data-sentiment');

            const text = textCell ? textCell.innerText.toLowerCase() : "";

            const matchText = !query || text.includes(query);
            const matchSentiment = !sentiment || rowSentiment === sentiment;

            row.style.display = (matchText && matchSentiment) ? '' : 'none';
        });
    }

    searchInput.addEventListener('input', applyFilters);
    sentimentFilter.addEventListener('change', applyFilters);

    // первый вызов — без фильтров
    applyFilters();
});
</script>


{% endblock %}
